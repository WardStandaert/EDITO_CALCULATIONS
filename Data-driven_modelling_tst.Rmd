---
title: "Predictive modelling of Atlantic herring larvae in the Northeast Atlantic Ocean"
author: "Ward Standaert"
date: "2024-04-22"
output:
  html_document:
    css: bootstrap.min.css
    self_contained: false
    toc: true
    toc_float:
      collapsed: false
    toc_depth: 2
    number_sections: false
    theme: default
    highlight: default
    df_print: paged
    fig_width: 10
bibliography: references.bib
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#install and load packages
pckgs <- c("raster","sp","proj4","ncdf4","car","mgcv","dismo","rJava","ENMeval",
           "boot","gstat","mgcv", "ggplot2", "tidyr", "dynamicSDM", "stringr", 
           "mapdata", "base","tidync", "sf", "mapview", "ape", "spdep", 
           "spThin", "StatMatch", "CoordinateCleaner", "maxnet", "rasterVis",
           "tibble", "purrr", "tidyverse", "arrow", "tidyverse", "gridExtra")

installed_packages <- pckgs %in% rownames(installed.packages())

if (any(installed_packages == FALSE)) {
  install.packages(pckgs[!installed_packages])
}

invisible(lapply(pckgs, library, character.only = TRUE))
rm(pckgs)

#Rarr package needs separate install
# if (!require("BiocManager", quietly = TRUE))
#   install.packages("BiocManager")
# 
# BiocManager::install("Rarr")
library("Rarr")

setwd("/home/onyxia/work/EDITO_CALCULATIONS/")

```

# Introduction

Where do you think autumn-spawning Atlantic herring spawns? In order to explore the spawning distribution of Atlantic herring, species distribution models were created for larvae of herring.

# 1. Collect data and build model

## 1.1 Collect & organize occurrence data

We collect data of Atlantic herring larvae occurrences from 2000 - 2020 from the International Herring Larvae Surveys ([IHLS](https://www.ices.dk/data/data-portals/Pages/Eggs-and-larvae.aspx)). The occurrence dataset is read from a parquet file stored in the data lake.

```{r step 1,  fig.width = 7}
# the file to process
acf <- S3FileSystem$create(
  anonymous = T,
  scheme = "https",
  endpoint_override = "s3.waw3-1.cloudferro.com"
)

eurobis <- arrow::open_dataset(acf$path("emodnet/biology/eurobis_occurence_data/eurobisgeoparquet/eurobis_no_partition_sorted.parquet" ))
df_occs <- eurobis |> 
  filter(aphiaidaccepted==126417, datasetid==4423,
         longitude > -12, longitude < 10,
         latitude > 48, latitude < 62,
         observationdate >= as.POSIXct("2000-01-01"),
         observationdate <= as.POSIXct("2020-12-31")) |> 
  collect() 

glimpse(df_occs)

df_occs <- df_occs %>% 
  select(Latitude=latitude,
         Longitude=longitude, 
         Time=observationdate) %>%
  mutate(year = year(Time),
         month = month(Time))

mapview(df_occs %>% dplyr::select(Longitude) %>% pull,
        df_occs %>% dplyr::select(Latitude) %>% pull,
        crs = "epsg:4326")

table(df_occs$month)

```